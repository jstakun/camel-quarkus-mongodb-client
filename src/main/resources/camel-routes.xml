<?xml version="1.0" encoding="UTF-8"?>
<routes id="DBClient" xmlns="http://camel.apache.org/schema/spring"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://camel.apache.org/schema/spring https://camel.apache.org/schema/spring/camel-spring-3.18.0.xsd">
    <route id="Put to cache">
        <from uri="direct:putToCache"/>
        <doTry>
        	<log loggingLevel="INFO" message="Inserting to collection ${header.cid} 1 document..."/>
        	<convertBodyTo type="java.lang.String"/>
        	<to uri="direct:insertRecord"/>
        	<log loggingLevel="INFO" message="Done"/>
        	<setBody>
            	<simple>{"id": "${header.CamelMongoOid}"}</simple>
        	</setBody>
        	<removeHeaders pattern="*"/>
        	<doCatch>
            	 <exception>java.lang.Exception</exception>
                 <to uri="direct:logError"/>
            </doCatch>
        </doTry>
    </route>
    <route id="Insert record to collection">
        <from uri="direct:insertRecord"/>
        <recipientList>
            <simple>mongodb:camelMongoClient?database={{quarkus.mongodb.database}}&amp;collection=${header.cid}&amp;operation=save</simple>
        </recipientList>
        <log loggingLevel="INFO" message="Inserted to collection ${header.cid} document with id ${header.CamelMongoOid}"/>
    </route>
    <route id="Get from cache">
        <from uri="direct:getFromCache"/>
        <doTry>
        	<validate>
            	<simple>${header.limit} range '1..{{app.batch.limit}}'</simple>
        	</validate>
        	<log loggingLevel="INFO" message="Get all from cache ${header.cid} with limit ${header.limit}"/>
        	<setHeader name="CamelMongoDbSortBy">
            	<!--  descending by _id -->
            	<constant>{"_id" : -1}</constant>
        	</setHeader>
        	<setHeader name="CamelMongoDbLimit">
            	<simple>${header.limit}</simple>
        	</setHeader>
        	<setHeader name="CamelMongoDbBatchSize">
            	<constant>{{app.batch.limit}}</constant>
        	</setHeader>
        	<recipientList>
            	<simple>mongodb:camelMongoClient?database={{quarkus.mongodb.database}}&amp;collection=${header.cid}&amp;operation=findAll</simple>
        	</recipientList>
        	<to uri="direct:processOutput"/>
	        <doCatch>
            	 <exception>java.lang.Exception</exception>
                 <to uri="direct:logError"/>
            </doCatch>
        </doTry>
    </route>
    <route id="Get from cache by id">
        <from uri="direct:getFromCacheById"/>
        <doTry>
        	<log loggingLevel="INFO" message="Get from cache ${header.cid} document with id ${header.oid}"/>
        	<setBody>
        		<simple>${header.oid}</simple>
        	</setBody>
        	<convertBodyTo type="org.bson.types.ObjectId"/> 	
        	<recipientList>
            	<simple>mongodb:camelMongoClient?database={{quarkus.mongodb.database}}&amp;collection=${header.cid}&amp;operation=findById</simple>
        	</recipientList>
        	<to uri="direct:processOutput"/>
	        <doCatch>
            	 <exception>java.lang.Exception</exception>
                 <to uri="direct:logError"/>
            </doCatch>
        </doTry>
    </route>
    <route id="Get by query from cache">
        <from uri="direct:getByQueryFromCache"/>
        <doTry>
        	<validate>
            	<simple>${header.limit} range '1..{{app.batch.limit}}'</simple>
        	</validate>
        	<setHeader name="CamelMongoDbSortBy">
            	<simple>{"_id" : -1}</simple>
        	</setHeader>
        	<setHeader name="CamelMongoDbLimit">
            	<simple>${header.limit}</simple>
        	</setHeader>
        	<setHeader name="CamelMongoDbCriteria">
            	<simple>${body}</simple>
        	</setHeader>
        	<log loggingLevel="INFO" message="Get from cache ${header.cid} by ${body} with limit ${header.limit}"/>
        	<recipientList>
            	<simple>mongodb:camelMongoClient?database={{quarkus.mongodb.database}}&amp;collection=${header.cid}&amp;operation=findAll</simple>
        	</recipientList>
        	<log loggingLevel="INFO" message="Done"/>
        	<to uri="direct:processOutput"/>
            <doCatch>
            	 <exception>java.lang.Exception</exception>
                 <to uri="direct:logError"/>
            </doCatch>
        </doTry> 	
    </route>
    <route id="Aggregate from cache">
        <from uri="direct:aggregateFromCache"/>
        <doTry>
        	<log loggingLevel="INFO" message="Aggregate from cache ${header.cid} by ${body}"/>
       	    <convertBodyTo type="java.lang.String"/>
        	<recipientList>
            	<simple>mongodb:camelMongoClient?database={{quarkus.mongodb.database}}&amp;collection=${header.cid}&amp;operation=aggregate</simple>
        	</recipientList>
        	<log loggingLevel="INFO" message="Done"/>
        	<to uri="direct:processOutput"/>
            <doCatch>
            	 <exception>java.lang.Exception</exception>
                 <to uri="direct:logError"/>
            </doCatch>
        </doTry> 	
    </route>
    <route id="Get db stats">
        <from uri="direct:getDbStats"/>
        <doTry>
        	<to uri="mongodb:camelMongoClient?database={{quarkus.mongodb.database}}&amp;operation=getDbStats"/>
        	<to uri="direct:processOutput"/>
    		<doCatch>
            	 <exception>java.lang.Exception</exception>
                 <to uri="direct:logError"/>
            </doCatch>
        </doTry>    
    </route>
    <route id="Delete from cache">
        <from uri="direct:deleteFromCache"/>
        <doTry>
        	<log loggingLevel="INFO" message="Delete from collection ${header.cid} objects matching ${header.property}: ${header.value}"/>
        	<setBody>
            	<simple>{"${header.property}" : "${header.value}"}</simple>
        	</setBody>
        	<recipientList>
            	<simple>mongodb:camelMongoClient?database={{quarkus.mongodb.database}}&amp;collection=${header.cid}&amp;operation=remove</simple>
        	</recipientList>
        	<setBody>
            	<simple>{"count": ${header.CamelMongoDbRecordsAffected}}</simple>
        	</setBody>
        	<removeHeaders pattern="*"/>
            <doCatch>
            	 <exception>java.lang.Exception</exception>
                 <to uri="direct:logError"/>
            </doCatch>
        </doTry>	
    </route>
    <route id="Log error">
        <from uri="direct:logError"/>
        <log loggingLevel="ERROR" message="Operation failed with exception: ${exception.stacktrace}"/>
        <setBody>
            <simple>{"error" : "Operation failed"}</simple>
        </setBody>
        <removeHeaders pattern="*"/>
        <setHeader name="CamelHttpResponseCode">
            <constant>500</constant>
        </setHeader>
    </route>
    <route id="Process output">
        <from uri="direct:processOutput"/>
        <marshal>
            <json id="json-po" library="Jackson"/>
        </marshal>
        <choice> 
        	<when>
            	<simple>${headers.accept-encoding} contains 'gzip'</simple>
				<marshal>
					<gzipDeflater id="gzip"/>
				</marshal>
				<setHeader name="content-encoding">
            		<constant>gzip</constant>
        		</setHeader>
        		<removeHeaders pattern="accept*"/>
        	</when>
			<otherwise> 
        		<removeHeaders pattern="*"/>
			</otherwise>
		</choice>
    </route>

    <!--  RH Summit --> 

    <route id="Register user">
        <from uri="direct:registerUser"/>
        <doTry>
        	<unmarshal>
            	<json id="json-re" library="Jackson" unmarshalType="org.redhat.Registration"/>
        	</unmarshal>
        	<setHeader name="x-redhat-email">
            	<simple>${body.email}</simple>
        	</setHeader>
        	<setHeader name="x-redhat-nick">
            	<simple>${body.nick}</simple>
        	</setHeader>
        	<setBody>
            	 <simple>{"email": "${header.x-redhat-email}"}</simple>
        	</setBody>
        	<recipientList>
            	 <simple>mongodb:camelMongoClient?database={{quarkus.mongodb.database}}&amp;collection=${header.cid}&amp;operation=findOneByQuery</simple>
        	</recipientList>
        	<choice>
            	 <when>
             		<simple>${header.CamelMongoDbResultTotalSize} == 1</simple>
             		<process ref="RegistrationProcessor"/>
             		<choice>
             			<when>
             		    	<simple>${header.CamelHttpResponseCode} == 200</simple>
             				<to uri="direct:insertRecord"/>
             				<setBody>
            					<simple>{"id": "${header.CamelMongoOid}"}</simple>
        					</setBody>
             			</when>
             		</choice>	
        		</when>	
            	<otherwise>
		        	<setHeader name="CamelHttpResponseCode">
        		    	<constant>404</constant>
        			</setHeader>
             	</otherwise>			  
        	</choice>
        	<removeHeaders pattern="x-redhat*"/>	
        	<removeHeader name="cid"/>
        	<doCatch>
            	 <exception>java.lang.Exception</exception>
                 <to uri="direct:logError"/>
            </doCatch>
        </doTry>   
    </route>
    <route id="Get top labels">
        <from uri="direct:getTopLabels"/>
        <doTry>
            <setHeader name="cid">
 				<simple>{{app.mongodb.default.collection}}</simple>           		
            </setHeader> 
            <setBody>
        		<simple>[{ "$match": { "type": "response" } }, { "$unwind": "$content.detections" }, { "$match": { "content.detections.score": { $gt: {{app.recognition.percent}} } } }, { "$group": { "_id": "$content.detections.label", "total": { $sum: 1 } } }, { "$sort" : { total : -1 } }]</simple>
        	</setBody>
         	<to uri="direct:aggregateFromCache"/>
    		<doCatch>
            	 <exception>java.lang.Exception</exception>
                 <to uri="direct:logError"/>
            </doCatch>
        </doTry>    
    </route>
    <route id="Get top users">
        <from uri="direct:getTopUsers"/>
        <doTry>
            <setHeader name="cid">
 				<simple>{{app.mongodb.default.collection}}</simple>           		
            </setHeader> 
            <setBody>
        		<simple>[{ "$match": { "type": "response" } }, { "$unwind": "$content.detections" }, { "$match": { "content.detections.score": { $gt: {{app.recognition.percent}} } } }, { "$group": { "_id": "$uid", labels: {$addToSet: "$content.detections.label"} } }, { "$project": { "_id" : 1, count: { "$size": "$labels" } } }, { "$sort" : { count : -1 } }]</simple>
        	</setBody>
         	<to uri="direct:aggregateFromCache"/>
    		<doCatch>
            	 <exception>java.lang.Exception</exception>
                 <to uri="direct:logError"/>
            </doCatch>
        </doTry>    
    </route> 
    <route id="Get labels by users">
        <from uri="direct:getLabelsByUser"/>
        <doTry>
            <setHeader name="cid">
 				<simple>{{app.mongodb.default.collection}}</simple>           		
            </setHeader> 
            <setBody>
        		<simple>[{ "$match": { "type": "response", "uid": "${header.uid}" } }, { "$unwind": "$content.detections" }, { "$match": { "content.detections.score": { $gt:  {{app.recognition.percent}}  } } }, { "$group": { "_id": "$content.detections.label", "count": { $sum: 1 } } }, { "$sort" : { count : -1 } }]</simple>
        	</setBody>
         	<to uri="direct:aggregateFromCache"/>
    		<doCatch>
            	 <exception>java.lang.Exception</exception>
                 <to uri="direct:logError"/>
            </doCatch>
        </doTry>        
    </route>    
</routes>
